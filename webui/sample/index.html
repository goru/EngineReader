<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">

    <title>EngineReader</title>

    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">

    <script type="text/javascript">
      function readUnreadButton(button) {
        var feedId = button.attr('feed');
        var entryId = button.attr('entry');
        var state = button.hasClass('active');

        if (state) {
          $.post('/api/feeds/' + feedId + '/' + entryId + '/unread');
        } else {
          $.post('/api/feeds/' + feedId + '/' + entryId + '/read');
        }

        button.toggleClass('btn-primary');
        button.children('i').toggleClass('icon-white');
      }

      function loadEntries(feedId) {
        $.getJSON('/api/feeds/' + feedId + '/unread', function(json) {
          for(var i in json.entries) {
            var entry = json.entries[i];

            $('#' + feedId).append('<div class="span12"><div class="container entry-container" id="wrap-' + entry.id + '"></div></div>');

            $('#wrap-' + entry.id).append('<div class="entry-header"><h4><a class="entry-link" id="title-' + entry.id
              + '" href="' + entry.url + '" target="_blank" entry="'
              + entry.id + '">' + entry.title + '</a></h4></div>');

            $('#wrap-' + entry.id).append('<div class="entry-body">'
              + entry.description + '</div>');

            $('#wrap-' + entry.id).append('<div class="entry-footer">'
              + '<button type="button" class="btn btn-primary entry-read-button" data-toggle="button" '
              + 'id="button-'+ entry.id + '" feed="' + feedId + '" entry="' + entry.id + '">'
              + '<i class="icon-check icon-white"></i> Read</button>'
              + '</div>');

            $('#wrap-' + entry.id).click(function() {
              var current = getCurrentEntry();
              if (current != null) {
                current.removeClass('entry-container-selected');
              }
              $(this).addClass('entry-container-selected');

              var button = $('.entry-container-selected .entry-read-button').eq(0);
              if (!button.hasClass('active')) {
                readUnreadButton(button);
                button.button('toggle');
              }
            });

            $('#button-' + entry.id).click(function() {
              readUnreadButton($(this));
            });
          }
        });
      }

      $(function() {
        $('#header').html('<div class="alert alert-info">Loading...</div>');
        $.getJSON('/api/feeds/', function(json) {
          for(var i in json.feeds) {
            var feed = json.feeds[i];

            $('#body').append('<div class="span12"><h3>' + feed.title
              + '</h3><div class="row" id="' + feed.id + '"></div></div>');

            loadEntries(feed.id);
          }

          $('#header').html('');
        });

        $('#addModal').on('show', function () {
          $('#inputTitle').val('');
          $('#inputURL').val('');
          $('#addModalButton').button('reset');
        });

        $('#addModalButton').click(function() {
          $(this).button('loading');
          var titleVal = $('#inputTitle').val();
          var urlVal = $('#inputURL').val();
          var data = JSON.stringify({ "title": titleVal, "url": urlVal });

          $.post('/api/feeds/', data, function(data) {
            window.location = '/';
          }).fail(function () {
          }).always(function () {
            $('#addModalButton').button('reset');
          });
        });

        $('#importModal').on('show', function () {
          $('#importDummyFile').val('');
          $('#inputOPML').html('OPML File');
          $('#importModalButton').button('reset');
        });

        $('#inputOPMLButton').click(function () {
          $('#importDummyFile').click();
        });

        $('#importDummyFile').change(function () {
          $('#inputOPML').html($(this).val());
        });

        $('#importModalButton').click(function() {
          $(this).button('loading');

          var $form, fd;
          $form = $('#importDummyForm');
          fd = new FormData($form[0]);
          $.ajax($form.attr("action"), {
            type: 'post',
            processData: false,
            contentType: false,
            data: fd,
            dataType: 'html',
            success: function(data){
              window.location = '/';
            },
            error: function() {
            },
            complete: function() {
              $('#importModalButton').button('reset');
            }
          });
        });
      });

      function getCurrentEntry() {
        var elm = $('.entry-container-selected');
        if (elm.length != 0) {
          return elm.eq(0);
        } else {
          return null;
        }
      }

      // hook keyboard input
      $(window).keydown(function (event) {
        if (event.shiftKey || event.ctrlKey) {
          return true;
        }

        switch(event.keyCode) {
          case 74: // j, next entry
            var entries = $('.entry-container');
            var current = getCurrentEntry();

            var index = 0;
            if (current != null) {
              index = entries.index(current) + 1;
            }

            if (entries.length > index) {
              if (current != null) {
                current.removeClass('entry-container-selected');
              }

              var next = entries.eq(index);
              next.addClass('entry-container-selected');

              var pos = next.offset().top;
              $('html,body').animate({ scrollTop: pos - 50 }, 'fast');

              var button = $('.entry-container-selected .entry-read-button').eq(0);
              if (!button.hasClass('active')) {
                readUnreadButton(button);
                button.button('toggle');
              }
            }
          case 75: // k, prev entry
          case 77: // m, toggle read,unread
          case 86: // v, view entry
            break;
          default:
            return true;
        }

        event.preventDefault();
        return true;
      });
    </script>

    <style type="text/css">
      body {
        background-color: rgb(245, 245, 245);
      }

      #padding-for-desktop {
        padding-top: 40px
      }

      .hidden-container {
        display: none;
      }

      .entry-container {
        border: 1px solid rgba(0, 0, 0, 0.3);
        border-radius: 6px 6px 6px 6px;
        margin: 0px 0px 10px;
        background-color: rgb(255, 255, 255);
      }

      .entry-container-selected {
        border: 1px solid rgba(82, 168, 236, 0.8);
      }

      .entry-header {
        padding: 5px 10px;
        border-bottom: 1px solid rgb(238, 238, 238);
      }

      .entry-body {
        padding: 10px;
      }

      .entry-footer {
        padding: 10px;
        margin-bottom: 0px;
        text-align: right;
        background-color: rgb(245, 245, 245);
        border-top: 1px solid rgb(221, 221, 221);
        border-radius: 0px 0px 6px 6px;
      }
    </style>

  </head>

  <body>
    <div class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
        <div class='container'>
          <ul class="nav">
            <li class="active"><a href="/"><i class="icon-home icon-white"></i> Home</a></li>
          </ul>
          <ul class="nav pull-right">
            <li><a href="#addModal" data-toggle="modal"><i class="icon-plus-sign icon-white"></i> Add</a></li>
            <li><a href="#importModal" data-toggle="modal"><i class="icon-upload icon-white"></i> Import</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="addModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="addModalLabel">Add New Feed</h3>
        </div>
        <div class="modal-body">

          <form class="form-horizontal">
            <div class="control-group">
              <label class="control-label" for="inputTitle">Title</label>
              <div class="controls">
                <input class="input-large" id='inputTitle' type="text" placeholder="Title">
              </div>
            </div>
            <div class="control-group">
              <label class="control-label" for="inputURL">URL</label>
              <div class="controls">
                <input class="input-large" id='inputURL' type="text" placeholder="URL">
              </div>
            </div>
          </form>

        </div>
        <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button id='addModalButton' class="btn btn-primary" data-loading-text="Adding...">Add</button>
      </div>
    </div>

    <div class='hidden-container'>
      <form id='importDummyForm' method='post' action='/api/feeds/import' enctype='multipart/form-data'>
        <input type="file" id="importDummyFile" name="opml">
        <input id="importDummySubmit" type="submit">
      </form>
    </div>

    <div id="importModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="importModalLabel">Import Feeds</h3>
        </div>
        <div class="modal-body">

          <form class="form-horizontal">
            <div class="control-group">
              <label class="control-label" for="inputOPMLContainer">OPML File</label>
              <div class="controls">
                <div class='input-append' id='inputOPMLContainer'>
                  <span class="input-large uneditable-input" id='inputOPML' type="text">OPML File</span>
                  <button class="btn" type="button" id='inputOPMLButton'>Select</button>
                </div>
              </div>
            </div>
          </form>

        </div>
        <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button id='importModalButton' class="btn btn-primary" data-loading-text="Importing...">Import</button>
      </div>
    </div>

    <div class='container visible-desktop' id='padding-for-desktop'></div>

    <div class='container'>
      <div class='row' id='header'></div>
      <div class='row' id='body'></div>
      <div class='row' id='footer'></div>
    </div>
  </body>

</html>
